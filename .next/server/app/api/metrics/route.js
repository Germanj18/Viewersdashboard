"use strict";(()=>{var e={};e.id=996,e.ids=[996],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},37656:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>v,patchFetch:()=>k,requestAsyncStorage:()=>w,routeModule:()=>d,serverHooks:()=>g,staticGenerationAsyncStorage:()=>m});var s={};t.r(s),t.d(s,{GET:()=>u,POST:()=>p});var a=t(49303),i=t(88716),o=t(60670),n=t(87070),c=t(88688);async function u(e){try{let{searchParams:r}=new URL(e.url),t=r.get("userId"),s=parseInt(r.get("days")||"7");if(!t)return n.NextResponse.json({success:!1,message:"userId is required"},{status:400});let a=await l(t),i=new Date;i.setDate(i.getDate()-s);let o=await c._.userMetrics.findMany({where:{userId:t,date:{gte:i}},orderBy:{date:"desc"}});return n.NextResponse.json({success:!0,realTimeMetrics:a,historicalMetrics:o})}catch(e){return console.error("Get metrics error:",e),n.NextResponse.json({success:!1,message:"Failed to fetch metrics",error:e instanceof Error?e.message:"Unknown error"},{status:500})}}async function p(e){try{let{userId:r}=await e.json();if(!r)return n.NextResponse.json({success:!1,message:"userId is required"},{status:400});let t=await l(r),s=new Date;s.setHours(0,0,0,0);let a=await c._.userMetrics.upsert({where:{userId_date:{userId:r,date:s}},update:{totalViewersSent:t.totalViewersSent,totalOperations:t.totalOperations,activeBlocks:t.activeBlocks,expiredBlocks:t.expiredBlocks,averageViewersPerHour:t.averageViewersPerHour,peakViewers:t.peakViewers,peakViewersTime:t.peakViewersTime},create:{userId:r,date:s,totalViewersSent:t.totalViewersSent,totalOperations:t.totalOperations,activeBlocks:t.activeBlocks,expiredBlocks:t.expiredBlocks,averageViewersPerHour:t.averageViewersPerHour,peakViewers:t.peakViewers,peakViewersTime:t.peakViewersTime}});return n.NextResponse.json({success:!0,message:"Metrics saved successfully",metrics:a})}catch(e){return console.error("Save metrics error:",e),n.NextResponse.json({success:!1,message:"Failed to save metrics",error:e instanceof Error?e.message:"Unknown error"},{status:500})}}async function l(e){let r;let t=await c._.operation.findMany({where:{userId:e}}),s=new Date,a=await c._.block.count({where:{userId:e,isActive:!0,endTime:{gt:s}}}),i=await c._.block.count({where:{userId:e,OR:[{isActive:!1},{endTime:{lt:s}}]}}),o=t.reduce((e,r)=>e+r.viewers,0),n=new Date;n.setHours(n.getHours()-24);let u=t.filter(e=>e.timestamp>=n),p=u.reduce((e,r)=>e+r.viewers,0),l=new Map;u.forEach(e=>{let r=e.timestamp.toISOString().slice(0,13);l.set(r,(l.get(r)||0)+e.viewers)});let d=0;return l.forEach((e,t)=>{e>d&&(d=e,r=new Date(t+":00:00Z"))}),{totalViewersSent:o,totalOperations:t.length,activeBlocks:a,expiredBlocks:i,averageViewersPerHour:p/24,peakViewers:d,peakViewersTime:r}}let d=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/metrics/route",pathname:"/api/metrics",filename:"route",bundlePath:"app/api/metrics/route"},resolvedPagePath:"C:\\Users\\German\\Desktop\\Dashboard Viewers- LaCasa\\youtube-viewers-lacasa\\src\\app\\api\\metrics\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:w,staticGenerationAsyncStorage:m,serverHooks:g}=d,v="/api/metrics/route";function k(){return(0,o.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:m})}},88688:(e,r,t)=>{t.d(r,{_:()=>a});var s=t(53524);let a=globalThis.prisma??new s.PrismaClient({log:["query","info","warn","error"]})}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[948,972],()=>t(37656));module.exports=s})();